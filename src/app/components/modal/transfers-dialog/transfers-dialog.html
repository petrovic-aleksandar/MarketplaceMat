<mat-card>
    <mat-card-header>
        <mat-card-title>User transfers</mat-card-title>
        @if (!loadingUser()) {
        <mat-card-subtitle>Current balance: {{user()?.balance}}</mat-card-subtitle>
        }
    </mat-card-header>
    <mat-card-content>
        <form [formGroup]="transferForm" (ngSubmit)="transfer()">
            <mat-form-field>
                <mat-label>Transfer type</mat-label>
                <mat-select formControlName="type">
                    <mat-option value="Payment">Payment</mat-option>
                    <mat-option value="Withdrawal">Withdrawal</mat-option>
                </mat-select>
                @if (transferForm.get('type')?.invalid && transferForm.get('type')?.touched) {
                <mat-error>Type is required</mat-error>
                }
            </mat-form-field>
            <mat-form-field>
                <mat-label>EUR</mat-label>
                <input matInput type="number" formControlName="amount">
                @if (transferForm.get('amount')?.invalid && transferForm.get('amount')?.touched) {
                <mat-error>Amount is required and must be greater than 0</mat-error>
                }
            </mat-form-field>
            <button matButton="tonal" type="submit" [disabled]="transferForm.invalid || submitting()">
              <mat-icon>save</mat-icon>
              {{ submitting() ? 'Processingâ€¦' : 'Send' }}
            </button>
        </form>

        @if (error()) {
        <div style="color: red; margin: 16px 0;">{{ error() }}</div>
        }

        @if (loadingTransfers()) {
        <div style="display: flex; justify-content: center; padding: 32px;">
          <mat-spinner [diameter]="40"></mat-spinner>
        </div>
        } @else {
        <table mat-table [dataSource]="transfersDS">
            <tr mat-header-row *matHeaderRowDef="cols"></tr>
            <tr mat-row *matRowDef="let row; columns: cols;"
                [ngClass]="{ 'transferMinus': row.type == 'Withdrawal' || row.type == 'Purchase' && row.seller == user()?.username, 'transferPlus': row.type == 'Payment' || row.type == 'Purchase' && row.buyer == user()?.username}">
            </tr>
            <ng-container matColumnDef="amount">
                <th mat-header-cell *matHeaderCellDef> Amount </th>
                <td mat-cell *matCellDef="let transfer">
                    @if(transfer.type == "Withdrawal" || transfer.type == "Purchase" && transfer.seller ==
                    user()?.username) {
                    +
                    }
                    @if(transfer.type == "Payment" || transfer.type == "Purchase" && transfer.buyer == user()?.username) {
                    -
                    }
                    {{transfer.amount}} </td>
            </ng-container>
            <ng-container matColumnDef="time">
                <th mat-header-cell *matHeaderCellDef> Time </th>
                <td mat-cell *matCellDef="let transfer"> {{transfer.time | date:"long"}} </td>
            </ng-container>
            <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef> Type </th>
                <td mat-cell *matCellDef="let transfer">{{transfer.type}}</td>
            </ng-container>
            <ng-container matColumnDef="buyer">
                <th mat-header-cell *matHeaderCellDef> Buyer </th>
                <td mat-cell *matCellDef="let transfer">{{transfer.buyer}}</td>
            </ng-container>
            <ng-container matColumnDef="seller">
                <th mat-header-cell *matHeaderCellDef> Seller </th>
                <td mat-cell *matCellDef="let transfer">{{transfer.seller}}</td>
            </ng-container>
            <ng-container matColumnDef="item">
                <th mat-header-cell *matHeaderCellDef> Item </th>
                <td mat-cell *matCellDef="let transfer">{{transfer.item}}</td>
            </ng-container>
        </table>
        <mat-paginator [length]="100" [pageSize]="5" aria-label="Select page">
        </mat-paginator>
        }
    </mat-card-content>
    <mat-card-actions>
        <div class="spacer"></div>
        <button matButton type="button" (click)="close()" [disabled]="submitting()"><mat-icon>close</mat-icon>Close</button>
    </mat-card-actions>
</mat-card>